---
editor_options: 
  markdown: 
    wrap: 72
---

# Results

## Part 1

#### 1. Boxplot

One of the most significant statistics of an index is its volatility.
For the very beginning, we would like to observe the volatilities of the
three indices by creating a boxplot:

```{r}
adj_price_minmax |>
  filter(date < "2020-01-01") |>
  ggplot(aes(x = symbol, y = norm_price)) + 
  geom_boxplot() + 
  coord_flip() +
  ggtitle("Boxplots of normalized adjusted prices of three indicies from 2010 to 2021") + 
  labs(y = "normalized prices", x = "Index Name")
```

From the boxplot, we can observe that the SSE Composite is a bit more
volatile with min and max values spanning the entire range from 0 to 1.
However, the IQR of these three indices are actually quite similar,
indicating that there is not an enormous difference in volatility among
the three markets.

```{r}
adj_price_minmax |>
  filter(date >= "2020-01-01") |>
  ggplot(aes(x = symbol, y = norm_price)) + 
  geom_boxplot() + 
  coord_flip() +
  ggtitle("Boxplots of normalized adjusted prices of three indicies in 2020") + 
  labs(y = "Normalized prices", x = "Index Name")
```

However, when we focus on the markets during the pandemic, we can
observe that the SSE Composite becomes more volatile with a
significantly larger IQR comparing with the other two indices.
Meanwhile, we also noticed that, although the S&P 500 and the Nikkei 225
seem to be less volatile, both of these two indices have significantly
more amount of outliers. While the Nikkei 225 index has both large and
small outliers, all of the outliers of S&P 500 are smaller than
$Q_1 - 1.5*IQR$.

#### 2. Candlestick Charts

To further observe the trends of the indices during the pandemic, we
adapted a popular type of diagram when it comes to the stock analysis,
the Candlestick Charts. For the purpose of tidyness, we created a
function to produce the candlestick chart for the given index and time
range.

```{r}
plot_candlestick <- function(target_symbol, from, to) {
  data_reg |>
    filter(date >= from & date <= to) |>
    filter(symbol == target_symbol) |>
    mutate(GreenRed = case_when(
      (open-close > 0) ~ "Red", 
      TRUE ~ "Green"
    )) |>
    ggplot() + 
    geom_segment(aes(x = date, xend = date, 
                     y = open, yend = close, 
                     colour = GreenRed), linewidth = 3) +
    theme_tq() + 
    geom_segment(aes(x = date, xend = date, 
                     y = low, yend = high, 
                     colour = GreenRed)) + 
    scale_color_manual(values = c("Forest Green", "Red")) + 
    ggtitle(paste0(target_symbol, " Index from ", from, " to ", to)) + 
    theme(text = element_text(size = 28), 
          legend.position = "none", 
          axis.title.y = element_blank())
}
```

```{r, fig.width=12, fig.height=7}
plot_candlestick("S&P_500", "2020-01-01", "2020-12-31")
```

For the candlestick chart of S&P 500 index in 2020, we can easily notice
the drop from approximately the end of February to end of March, which
is when the pandemic hit. The market shrank by approximately thirty
percent within a month. If we observe the chart carefully, we can notice
that there exist noticable gaps between some trading days, indicating
that the market was continuously impacted even after it was close. The
daily "candles" during this period were also significantly longer than
the others, indicating a volatile market. However, we can notice that
the market recovered gradually in the following six months and continued
with a growing trend.

```{r, fig.width=12, fig.height=7}
plot_candlestick("Nikkei_225", "2020-01-01", "2020-12-31")
```

Similar with the S&P 500, the Japanese market represented by Nikkei 225
index also took a significant impact from Covid-19 during February and
March in 2020. The number of green bars in this chart during the
pandemic period are even less than the ones in the previous chart of S&P
500 index. However, the average length of each "candle" of Nikkei 225 is
shorter than the one of S&P 500. This shows that the Japanese market
shrank in a more stable path. In addition, the price of the index
recovered from the impact within only approximately 4 month, which is
shorter than the US market.

```{r, fig.width=12, fig.height=7}
plot_candlestick("SSE_Composite", "2020-01-01", "2020-12-31")
```

SSE Composite index, on the other side, has a very different trend
comparing with the other two indices. Although there is a drop in price
between February and March, the market rebounded back to previous prices
during the February. After April, the market gradually has recovered
with an upward trend until July, when a significant boost happened to
the local market. This boost might be caused by the local policy of
opening up after the quarantines. Overall, the trend of SSE Composite is
different, and the volatility of the Chinese market was increased due to
the potential stimulation of policies.

#### 3. Time Series Line charts

```{r, fig.width=12, fig.height=7}
adj_price_minmax |>
  mutate(symbol = forcats::fct_reorder2(symbol, date, norm_price)) |>
  ggplot(aes(x = date, y = norm_price, color = symbol)) +
  geom_point(size = 1.5, fill = "black", shape = 21) + 
  geom_line(lwd = 1) + 
  facet_wrap(~symbol, nrow = 3, scales = "free_y") + 
  geom_smooth(method = "loess", span = .2, se = FALSE, linewidth = 1, colour = "black", linetype = 1) +
  ggtitle("Normalized prices of indices from 2016 to 2020") + 
  labs(x = "", y = "normalized price") +
  theme_grey(16) +
  theme(text = element_text(size = 28), 
        legend.key.size = unit(1.5, 'cm'))
```

By aligning the three indices together, there are several things that we can easily notice. 
First of all, the S&P 500 index is the most stable index with a smooth upward trend line, 
while the SSE Composite is obviously more unstable in the last five years. In addition, the 
US market and Japanese market performs very similar in the general trends if we compare the 
two smooth lines. Lastly, the pandemic contributed to the largest drop of S&P 500 and 
Nikkei 225 in 5 years. However, the drop in SSE Composite caused by the pandemic was 
relatively insignificant comparing with the overall performance of SSE Composite in 
5 years. 

To give the impacts of Covid-19 on markets a closer look, we focus on the data in 2020 and 
created another similar plot:

```{r, fig.width=12, fig.height=7, warning = FALSE}
adj_price_minmax |>
  filter(date >= "2020-01-01") |>
  mutate(symbol = forcats::fct_reorder2(symbol, date, norm_price)) |>
  ggplot(aes(x = date, y = norm_price, color = symbol)) +
  geom_point(size = 2.5, fill = "black", shape = 21) + 
  geom_line(lwd = 1.5) + 
  facet_wrap(~symbol, nrow = 3, scales = "free_y") + 
  geom_smooth(method = "loess", span = .2, se = FALSE, linewidth = 1, colour = "black", linetype = 1) +
  ggtitle("Normalized prices of indices in 2020") + 
  labs(x = "", y = "normalized price") +
  theme_grey(16) +
  theme(text = element_text(size = 28), 
        legend.key.size = unit(1.5, 'cm'))
```

With the zoomed data, we can observe that although the overall trends of the markets 
are similar, all dropped before April and turned upward, the S&P index and the Nikkei 225 
index shares more similarity when it comes to the shapes and detailed trends of the prices 
in 2020. From this plot, we can better infer that the Chinese equity market was less influenced 
by the Covid-19 pandemic, while both the US market and the Japanese market were influenced 
by the pandemic negatively in a similar way. 

#### Returns

Another method of displaying volatility and comparing impacts from the pandemic 
across three markets is to use daily returns. In the following part, the log daily 
returns of the three indices are plotted separately to be observed. 

```{r, fig.width=6, fig.height=3}
data_reg |>
  filter(symbol == "S&P_500") |>
  mutate(return = log(adjusted) - log(lag(adjusted))) |>
  drop_na() |>
  select(date, symbol, return) |>
  mutate(pandemic = case_when(
    (date >= "2020-01-01") ~ "pandemic", 
    TRUE ~ "normal"
  )) |>
  ggplot(aes(x = date, y = return, fill = pandemic, colour = pandemic)) + 
  geom_col() + 
  scale_color_manual(values = c("normal" = "#999999", "pandemic" = "#E69F00")) + 
  scale_fill_manual(values = c("normal" = "#999999", "pandemic" = "#E69F00")) + 
  ggtitle("Log Returns of S&P 500 index before and during the pandemic") + 
  theme(legend.title = element_blank(), 
        axis.title.y = element_blank(), 
        text = element_text(size = 18), 
        legend.key.size = unit(1, 'cm'))
```

In this plot, we observed a clear increase in volatility during the Covid-19 pandemic. 
Before 2020, the log returns are represented with grey vertical bars and has a relatively 
low range. After the pandemic hit the market, the amplitude of log returns increased by 
a large amount for several month till it drop back down to the normal level. 

```{r, fig.width=6, fig.height=3}
data_reg |>
  filter(symbol == "Nikkei_225") |>
  mutate(return = log(adjusted) - log(lag(adjusted))) |>
  drop_na() |>
  select(date, symbol, return) |>
  mutate(pandemic = case_when(
    (date >= "2020-01-01") ~ "pandemic", 
    TRUE ~ "normal"
  )) |>
  ggplot(aes(x = date, y = return, fill = pandemic, colour = pandemic)) + 
  geom_col() + 
  scale_color_manual(values = c("normal" = "#999999", "pandemic" = "#E69F00")) + 
  scale_fill_manual(values = c("normal" = "#999999", "pandemic" = "#E69F00")) + 
  ggtitle("Log Returns of Nikkei 225 index before and during the pandemic") + 
  theme(legend.title = element_blank(), 
        axis.title.y = element_blank(), 
        text = element_text(size = 18), 
        legend.key.size = unit(1, 'cm'))
```

From the return plots, 

```{r, fig.width=6, fig.height=3}
data_reg |>
  filter(symbol == "SSE_Composite") |>
  mutate(return = log(adjusted) - log(lag(adjusted))) |>
  drop_na() |>
  select(date, symbol, return) |>
  mutate(pandemic = case_when(
    (date >= "2020-01-01") ~ "pandemic", 
    TRUE ~ "normal"
  )) |>
  ggplot(aes(x = date, y = return, fill = pandemic, colour = pandemic)) + 
  geom_col() + 
  scale_color_manual(values = c("normal" = "#999999", "pandemic" = "#E69F00")) + 
  scale_fill_manual(values = c("normal" = "#999999", "pandemic" = "#E69F00")) + 
  ggtitle("Log Returns of SSE Composite index before and during the pandemic") + 
  theme(legend.title = element_blank(), 
        axis.title.y = element_blank(), 
        text = element_text(size = 18), 
        legend.key.size = unit(1, 'cm'))
```

## Part 2

```{r fig.width=9, fig.height=6}
ggplot(data_sec, aes(x = adjusted, y = as.factor(sector), fill = factor(stat(quantile)))) + 
  stat_density_ridges(
    geom = "density_ridges_gradient",
    quantiles = 4, quantile_lines = TRUE
  ) +
  scale_fill_viridis_d(name = "Quartiles") +
  ggtitle("Ridgeline plots for 11 sectors from 2016 to 2020")
```

#### Timeseries line plots

```{r}
data_sec %>%
  mutate(sector = fct_reorder2(sector, date, adjusted)) %>%
  ggplot(aes(date, adjusted, color = sector)) +
  geom_line() +
  scale_x_date(date_breaks="1 year", date_labels="%Y") +
  ggtitle("Line plots for 11 sectors from 2016 to 2020")
```

```{r fig.width=9, fig.height=6}
data_sec |> filter(date >= "2020-01-01" & date <= "2020-12-31") |>
  mutate(sector = fct_reorder2(sector, date, adjusted)) %>%
  ggplot(aes(date, adjusted, color = sector)) +
  geom_line() +
  scale_x_date(date_breaks="1 month", labels = date_format("%m")) +
  ggtitle("Line plots for 11 sectors in 2020")
```

#### Timeseries Smooth plots

```{r fig.width=9, fig.height=7}
ggplot(data_sec, aes(date, adjusted)) + 
  facet_wrap(~ sector, scales = 'free_x') +
  geom_smooth(span = 0.1) +
  ggtitle("Faceted Smooth plots for 11 sectors from 2016 to 2020")
```

```{r fig.width=9, fig.height=7}
data_sec |> filter(date >= "2020-01-01" & date <= "2020-12-31") |>
ggplot(aes(date, adjusted)) + 
  facet_wrap(~ sector, scales = 'free_x') +
  geom_smooth(span = 0.12) + 
  labs(x = "Month") +
  scale_x_date(labels = date_format("%m")) +
  ggtitle("Faceted Smooth plots for 11 sectors in 2020")
```
